<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>دليل الزكاة التفاعلي</title>
    <!-- Chosen Palette: Calm Harmony -->
    <!-- Application Structure Plan: A thematic, dashboard-style single-page application. The structure is designed for an exploratory user experience, guiding the user from foundational concepts to practical application and detailed inquiries. It starts with a hero section, followed by 'Core Concepts' using interactive cards, a central 'Zakat Calculator' for practical engagement, a 'Recipients of Zakat' section with a Chart.js visualization, an 'FAQ' section with an accordion for specific rulings, and a new Gemini-powered "Ask an Expert" section. This structure prioritizes user engagement and understanding. -->
    <!-- Visualization & Content Choices: 1. Core Concepts: Interactive HTML cards (Goal: Inform). 2. Zakat Calculator: Dynamic HTML form with JS (Goal: Apply). 3. Recipients: Chart.js Donut chart (Goal: Visualize). 4. FAQ: HTML/JS accordion (Goal: Organize). 5. New: Ask an Expert (اسأل خبيرًا) - A form that calls the Gemini API to answer user-specific questions, providing deep, personalized Fiqh guidance. 6. New: Suggest a Dua (اقتراح دعاء) - A button appears after calculation to call Gemini for a personalized prayer. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Cairo', sans-serif;
            scroll-behavior: smooth;
        }
        .chart-container {
            position: relative;
            margin: auto;
            height: 40vh;
            width: 100%;
            max-width: 450px;
            max-height: 450px;
        }
        .tab-button.active {
            border-color: #739072;
            color: #739072;
            background-color: #F5E8C7;
        }
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        .rtl {
            direction: rtl;
        }
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #739072;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 1rem;
            max-width: 500px;
            width: 90%;
            text-align: right;
        }
    </style>
</head>
<body class="bg-[#FDF6E3] text-[#65451F]">

    <!-- Header & Navigation -->
    <header class="bg-[#F5E8C7] shadow-md sticky top-0 z-50">
        <nav class="container mx-auto px-6 py-3">
            <div class="flex justify-between items-center">
                <h1 class="text-xl md:text-2xl font-bold text-[#739072]">دليل الزكاة التفاعلي ✨</h1>
                <div class="hidden md:flex space-x-6 space-x-reverse text-lg">
                    <a href="#concepts" class="hover:text-[#739072] transition-colors">مفاهيم أساسية</a>
                    <a href="#calculator" class="hover:text-[#739072] transition-colors">حاسبة الزكاة</a>
                    <a href="#recipients" class="hover:text-[#739072] transition-colors">مصارف الزكاة</a>
                    <a href="#faq" class="hover:text-[#739072] transition-colors">مسائل خاصة</a>
                    <a href="#expert-ask" class="hover:text-[#739072] transition-colors">اسأل خبيراً</a>
                </div>
                <div class="md:hidden">
                    <button id="menu-btn" class="text-[#65451F] focus:outline-none">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                    </button>
                </div>
            </div>
            <div id="mobile-menu" class="hidden md:hidden mt-4">
                 <a href="#concepts" class="block py-2 px-4 text-sm hover:bg-[#EAC696]">مفاهيم أساسية</a>
                 <a href="#calculator" class="block py-2 px-4 text-sm hover:bg-[#EAC696]">حاسبة الزكاة</a>
                 <a href="#recipients" class="block py-2 px-4 text-sm hover:bg-[#EAC696]">مصارف الزكاة</a>
                 <a href="#faq" class="block py-2 px-4 text-sm hover:bg-[#EAC696]">مسائل خاصة</a>
                 <a href="#expert-ask" class="block py-2 px-4 text-sm hover:bg-[#EAC696]">اسأل خبيراً</a>
            </div>
        </nav>
    </header>

    <main class="container mx-auto p-4 md:p-8">
        
        <!-- Hero Section -->
        <section class="text-center py-12">
            <h2 class="text-4xl font-bold text-[#739072] mb-4">الزكاة: الركن الثالث من أركان الإسلام</h2>
            <p class="text-lg max-w-3xl mx-auto">
                مرحباً بك في الدليل التفاعلي الشامل لأحكام الزكاة. يهدف هذا الدليل إلى تبسيط المفاهيم المعقدة وتقديم الأدوات اللازمة لحساب زكاتك وفهم مصارفها.
            </p>
        </section>

        <!-- Core Concepts Section -->
        <section id="concepts" class="py-12 bg-[#F5E8C7] rounded-xl p-8 my-8">
            <h2 class="text-3xl font-bold text-center mb-8 text-[#739072]">مفاهيم أساسية في الزكاة</h2>
            <div class="grid md:grid-cols-3 gap-8 text-center">
                <div class="bg-[#FDF6E3] p-6 rounded-lg shadow-lg">
                    <h3 class="text-2xl font-semibold mb-3">ما هي الزكاة؟</h3>
                    <p>الزكاة لغةً هي النماء والطهارة والبركة. وشرعًا، هي حق واجب في مال خاص لطائفة مخصوصة في وقت مخصوص. وهي عبادة مالية وركن أساسي لتطهير المال والنفس وتحقيق التكافل الاجتماعي.</p>
                </div>
                <div class="bg-[#FDF6E3] p-6 rounded-lg shadow-lg">
                    <h3 class="text-2xl font-semibold mb-3">أهميتها في الإسلام</h3>
                    <p>قرن الله سبحانه وتعالى الزكاة بالصلاة في مواضع كثيرة من القرآن الكريم، مما يدل على عظيم منزلتها. قال تعالى: ﴿وَأَقِيمُوا الصَّلَاةَ وَآتُوا الزَّكَاةَ﴾. وهي سبب لنيل رحمة الله والفلاح في الدنيا والآخرة.</p>
                </div>
                <div class="bg-[#FDF6E3] p-6 rounded-lg shadow-lg">
                    <h3 class="text-2xl font-semibold mb-3">شروط وجوبها</h3>
                    <ul class="list-disc list-inside text-right">
                        <li><strong>الإسلام:</strong> فلا تجب على غير المسلم.</li>
                        <li><strong>الحرية:</strong> فلا تجب على العبد.</li>
                        <li><strong>الملك التام:</strong> أن يكون المال مملوكاً لصاحبه ملكاً تاماً.</li>
                        <li><strong>النماء:</strong> أن يكون المال نامياً بالفعل أو بالقوة.</li>
                        <li><strong>بلوغ النصاب:</strong> وهو المقدار المعين شرعاً الذي تجب الزكاة ببلوغه.</li>
                        <li><strong>حولان الحول:</strong> أن يمضي على امتلاك النصاب عام هجري كامل (في غير الزروع والثمار).</li>
                    </ul>
                </div>
            </div>
        </section>

        <!-- Zakat Calculator Section -->
        <section id="calculator" class="py-12 my-8">
            <h2 class="text-3xl font-bold text-center mb-8 text-[#739072]">حاسبة الزكاة</h2>
            <div class="bg-white p-6 md:p-8 rounded-2xl shadow-xl max-w-4xl mx-auto border-2 border-[#EAC696]">
                <p class="text-center mb-6">
                    تهدف هذه الحاسبة إلى تيسير حساب الزكاة بأنواعها المختلفة. اختر نوع المال الذي تريد حساب زكاته واتبع الخطوات.
                </p>
                <div class="mb-6 border-b-2 border-[#EAC696] flex justify-center flex-wrap">
                    <button class="tab-button p-4 text-lg font-semibold border-b-4 border-transparent active" onclick="showTab('money')">النقود والذهب والفضة</button>
                    <button class="tab-button p-4 text-lg font-semibold border-b-4 border-transparent" onclick="showTab('trade')">عروض التجارة</button>
                    <button class="tab-button p-4 text-lg font-semibold border-b-4 border-transparent" onclick="showTab('agriculture')">الزروع والثمار</button>
                </div>
                <div id="money" class="tab-content rtl"><h3 class="text-2xl font-semibold mb-4 text-center">زكاة النقود والذهب والفضة</h3><div class="grid md:grid-cols-2 gap-6 items-start"><div><label for="money_type" class="block font-semibold mb-2">نوع المال:</label><select id="money_type" class="w-full p-2 border border-gray-300 rounded-lg mb-4" onchange="updateNisabInfo()"><option value="gold">الذهب (عيار 24)</option><option value="silver">الفضة</option><option value="cash">النقود (حسب نصاب الذهب)</option></select><label for="money_amount" class="block font-semibold mb-2">المقدار/القيمة:</label><input type="number" id="money_amount" placeholder="أدخل المقدار بالغرام أو القيمة النقدية" class="w-full p-2 border border-gray-300 rounded-lg"></div><div class="bg-[#FDF6E3] p-4 rounded-lg"><h4 class="font-bold text-lg mb-2">معلومات النصاب:</h4><p id="nisab_info" class="mb-2"><strong>نصاب الذهب:</strong> 85 غراماً من الذهب الخالص.</p><p class="text-sm">ملاحظة: تجب الزكاة إذا بلغ المال النصاب ومضى عليه عام هجري كامل. مقدار الزكاة هو 2.5% (ربع العشر).</p></div></div><div class="text-center mt-6"><button onclick="calculateMoneyZakat()" class="bg-[#739072] text-white font-bold py-2 px-8 rounded-lg hover:bg-opacity-90 transition-all">احسب</button></div><div id="money_result" class="mt-6 text-center text-xl font-bold"></div></div>
                <div id="trade" class="tab-content hidden rtl"><h3 class="text-2xl font-semibold mb-4 text-center">زكاة عروض التجارة</h3><div class="grid md:grid-cols-2 gap-6 items-start"><div><label for="trade_value" class="block font-semibold mb-2">قيمة البضاعة المعدة للبيع (بسعر البيع الحالي):</label><input type="number" id="trade_value" placeholder="أدخل قيمة البضاعة" class="w-full p-2 border border-gray-300 rounded-lg mb-4"><label for="trade_cash" class="block font-semibold mb-2">السيولة النقدية الناتجة عن التجارة:</label><input type="number" id="trade_cash" placeholder="أدخل قيمة السيولة" class="w-full p-2 border border-gray-300 rounded-lg mb-4"><label for="trade_debt" class="block font-semibold mb-2">الديون التي لك على الآخرين (المرجو سدادها):</label><input type="number" id="trade_debt" placeholder="أدخل قيمة الديون" class="w-full p-2 border border-gray-300 rounded-lg"></div><div class="bg-[#FDF6E3] p-4 rounded-lg"><h4 class="font-bold text-lg mb-2">طريقة الحساب:</h4><p class="mb-2">تُجمع قيمة البضاعة مع السيولة النقدية والديون المرجوة. إذا بلغ المجموع نصاب الذهب (ما يعادل 85 غراماً) وحال عليه الحول، وجبت فيه الزكاة بنسبة 2.5%.</p><p><strong>سعر الذهب اليوم (تقريبي):</strong> <span id="gold_price_trade">ادخل سعر الجرام</span> <input type="number" id="gold_price_input_trade" placeholder="سعر جرام الذهب" class="w-full p-1 border border-gray-300 rounded-lg mt-1 text-sm"></p></div></div><div class="text-center mt-6"><button onclick="calculateTradeZakat()" class="bg-[#739072] text-white font-bold py-2 px-8 rounded-lg hover:bg-opacity-90 transition-all">احسب</button></div><div id="trade_result" class="mt-6 text-center text-xl font-bold"></div></div>
                <div id="agriculture" class="tab-content hidden rtl"><h3 class="text-2xl font-semibold mb-4 text-center">زكاة الزروع والثمار</h3><div class="grid md:grid-cols-2 gap-6 items-start"><div><label for="crop_amount" class="block font-semibold mb-2">كمية المحصول (بالكيلوجرام):</label><input type="number" id="crop_amount" placeholder="أدخل كمية المحصول" class="w-full p-2 border border-gray-300 rounded-lg mb-4"><label for="irrigation_method" class="block font-semibold mb-2">طريقة الري:</label><select id="irrigation_method" class="w-full p-2 border border-gray-300 rounded-lg"><option value="natural">سقي بماء السماء أو الأنهار (بدون كلفة)</option><option value="artificial">سقي بالآلات (بكلفة)</option></select></div><div class="bg-[#FDF6E3] p-4 rounded-lg"><h4 class="font-bold text-lg mb-2">معلومات النصاب والمقدار:</h4><p class="mb-2"><strong>النصاب:</strong> 5 أوسق، أي ما يعادل 653 كيلوجراماً تقريباً. لا زكاة فيما دون ذلك.</p><p><strong>المقدار الواجب:</strong></p><ul class="list-disc list-inside"><li><strong>10% (العشر):</strong> إذا كان السقي بدون كلفة (بماء المطر).</li><li><strong>5% (نصف العشر):</strong> إذا كان السقي بكلفة (بالآلات).</li></ul></div></div><div class="text-center mt-6"><button onclick="calculateAgricultureZakat()" class="bg-[#739072] text-white font-bold py-2 px-8 rounded-lg hover:bg-opacity-90 transition-all">احسب</button></div><div id="agriculture_result" class="mt-6 text-center text-xl font-bold"></div></div>
            </div>
        </section>

        <!-- Recipients Section -->
        <section id="recipients" class="py-12 bg-[#F5E8C7] rounded-xl p-8 my-8"><h2 class="text-3xl font-bold text-center mb-2 text-[#739072]">لمن تُعطى الزكاة؟ (مصارف الزكاة)</h2><p class="text-center max-w-2xl mx-auto mb-8">حدد القرآن الكريم ثمانية أصناف تُصرف إليهم الزكاة. استكشفهم عبر هذا المخطط التفاعلي.</p><div class="flex flex-col md:flex-row items-center gap-8"><div class="w-full md:w-1/2"><div class="chart-container"><canvas id="recipientsChart"></canvas></div></div><div id="recipient-details" class="w-full md:w-1/2 bg-[#FDF6E3] p-6 rounded-lg shadow-inner min-h-[300px]"><h3 id="recipient-title" class="text-2xl font-bold mb-4 text-[#739072]">اختر صنفاً من الدائرة</h3><p id="recipient-description">مرر الفأرة أو اضغط على أحد الأقسام في الدائرة لعرض تفاصيل الصنف المستحق للزكاة.</p></div></div></section>

        <!-- FAQ Section -->
        <section id="faq" class="py-12 my-8"><h2 class="text-3xl font-bold text-center mb-8 text-[#739072]">مسائل خاصة وأسئلة شائعة</h2><div class="max-w-3xl mx-auto space-y-4"><div class="accordion-item bg-white rounded-lg shadow-md border border-[#EAC696]"><button class="accordion-header w-full text-right p-4 font-semibold text-lg flex justify-between items-center"><span>زكاة الفطر</span><span class="transform transition-transform duration-300">▼</span></button><div class="accordion-content"><p class="p-4 border-t border-[#EAC696]">هي زكاة تجب بالفطر من رمضان، وهي طهرة للصائم من اللغو والرفث وطعمة للمساكين. تجب على كل مسلم يملك قوت يوم العيد وليلته فاضلاً عن حاجته الأصلية. مقدارها صاع من غالب قوت البلد (حوالي 2.5 - 3 كجم)، ويجوز إخراج قيمتها نقداً عند بعض الفقهاء تيسيراً على الفقير.</p></div></div><div class="accordion-item bg-white rounded-lg shadow-md border border-[#EAC696]"><button class="accordion-header w-full text-right p-4 font-semibold text-lg flex justify-between items-center"><span>زكاة حُليّ النساء</span><span class="transform transition-transform duration-300">▼</span></button><div class="accordion-content"><p class="p-4 border-t border-[#EAC696]">هناك خلاف بين الفقهاء في هذه المسألة. الجمهور (المالكية والشافعية والحنابلة) على أنه لا زكاة في حلي النساء المباح المعد للاستعمال الشخصي ما لم يبلغ حد الإسراف. بينما يرى الحنفية وجوب الزكاة فيه إذا بلغ النصاب وحال عليه الحول، وهو الأحوط والأبرأ للذمة.</p></div></div><div class="accordion-item bg-white rounded-lg shadow-md border border-[#EAC696]"><button class="accordion-header w-full text-right p-4 font-semibold text-lg flex justify-between items-center"><span>زكاة الرواتب والأجور</span><span class="transform transition-transform duration-300">▼</span></button><div class="accordion-content"><p class="p-4 border-t border-[#EAC696]">الراتب الشهري هو مال مستفاد. الطريقة الأيسر والأحوط لحساب زكاته هي أن يحدد المزكي يوماً في السنة (مثلاً الأول من رمضان) ويقوم بجرد كل ما يملكه من أموال نقدية في ذلك اليوم، سواء كانت من مدخرات الرواتب أو غيرها. إذا بلغ المجموع النصاب، يخرج 2.5% منه. هذه الطريقة تضمن عدم إغفال حولان الحول على المبالغ المختلفة وتسهل الحساب.</p></div></div></div></section>
        
        <!-- Ask an Expert Section -->
        <section id="expert-ask" class="py-12 my-8">
            <h2 class="text-3xl font-bold text-center mb-8 text-[#739072]">✨ اسأل خبيرًا</h2>
            <div class="bg-white p-6 md:p-8 rounded-2xl shadow-xl max-w-4xl mx-auto border-2 border-[#EAC696]">
                <p class="text-center mb-6">هل لديك سؤال محدد حول الزكاة يتعلق بحالتك الشخصية؟ اكتب سؤالك هنا وسنقدم لك إجابة فقهية إرشادية.</p>
                <div class="rtl">
                    <textarea id="zakat-question" class="w-full p-3 border border-gray-300 rounded-lg mb-4" rows="4" placeholder="مثال: أملك محلاً تجارياً، كيف أحسب زكاته مع العلم أن عليّ ديوناً؟"></textarea>
                    <div class="text-center">
                         <button id="ask-expert-btn" onclick="askExpert()" class="bg-[#739072] text-white font-bold py-2 px-8 rounded-lg hover:bg-opacity-90 transition-all">
                            أرسل السؤال
                        </button>
                    </div>
                    <div id="expert-response-container" class="mt-6">
                        <div id="expert-loader" class="loader hidden"></div>
                        <div id="expert-answer" class="bg-[#FDF6E3] p-4 rounded-lg whitespace-pre-wrap"></div>
                    </div>
                     <p class="text-xs text-center mt-4 text-gray-500">
                        إخلاء مسؤولية: هذه الإجابة تم إنشاؤها بواسطة الذكاء الاصطناعي للإرشاد العام، وينصح دائمًا باستشارة عالم دين مؤهل للمسائل الشخصية.
                    </p>
                </div>
            </div>
        </section>

    </main>
    
    <footer class="bg-[#F5E8C7] text-center p-4 mt-12">
        <p>تم تصميم هذا الدليل التفاعلي بناءً على محتوى كتاب "الفقه الواضح من الكتاب والسنة" للدكتور محمد بكر إسماعيل.</p>
        <p>&copy; 2024 - دليل الزكاة التفاعلي.</p>
    </footer>

    <!-- Dua Modal -->
    <div id="dua-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-2xl font-bold mb-4 text-[#739072]">✨ دعاء مقترح</h3>
            <div id="dua-loader" class="loader hidden"></div>
            <p id="dua-text" class="text-lg"></p>
            <div class="text-left mt-6">
                <button onclick="closeModal()" class="bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-400">إغلاق</button>
            </div>
        </div>
    </div>


    <script>
        // Mobile menu toggle
        const menuBtn = document.getElementById('menu-btn');
        const mobileMenu = document.getElementById('mobile-menu');
        menuBtn.addEventListener('click', () => {
            mobileMenu.classList.toggle('hidden');
        });

        // Tabs functionality
        const tabs = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');

        function showTab(tabId) {
            tabContents.forEach(content => {
                content.classList.add('hidden');
            });
            tabs.forEach(tab => {
                tab.classList.remove('active');
            });

            document.getElementById(tabId).classList.remove('hidden');
            event.currentTarget.classList.add('active');
        }

        // Calculator Nisab Info Updater
        const nisab = {
            gold: 85,
            silver: 595,
        };

        function updateNisabInfo() {
            const moneyType = document.getElementById('money_type').value;
            const nisabInfo = document.getElementById('nisab_info');
            const amountInput = document.getElementById('money_amount');
            if (moneyType === 'gold') {
                nisabInfo.innerHTML = `<strong>نصاب الذهب:</strong> ${nisab.gold} غراماً من الذهب الخالص.`;
                amountInput.placeholder = "أدخل المقدار بالغرام";
            } else if (moneyType === 'silver') {
                nisabInfo.innerHTML = `<strong>نصاب الفضة:</strong> ${nisab.silver} غراماً من الفضة الخالصة.`;
                 amountInput.placeholder = "أدخل المقدار بالغرام";
            } else {
                nisabInfo.innerHTML = `<strong>نصاب النقود:</strong> ما يعادل قيمة ${nisab.gold} غراماً من الذهب.`;
                 amountInput.placeholder = "أدخل القيمة النقدية";
            }
        }
        
        function showDuaButton(resultDiv, context, amount) {
            const existingBtn = resultDiv.querySelector('.dua-btn');
            if(existingBtn) existingBtn.remove();

            const duaButton = document.createElement('button');
            duaButton.innerHTML = "✨ اقتراح دعاء مخصص";
            duaButton.className = "dua-btn bg-[#CBAF87] text-white font-bold py-2 px-4 rounded-lg hover:bg-opacity-90 transition-all mt-4 text-sm";
            duaButton.onclick = () => getDua(context, amount);
            resultDiv.appendChild(duaButton);
        }

        // Zakat Calculation Logic
        function calculateMoneyZakat() {
            const moneyType = document.getElementById('money_type').value;
            const amount = parseFloat(document.getElementById('money_amount').value);
            const resultDiv = document.getElementById('money_result');

            if (isNaN(amount) || amount <= 0) {
                resultDiv.innerHTML = `<span class="text-red-600">الرجاء إدخال مبلغ صحيح.</span>`;
                return;
            }
            
            let isNisabReached = false;
            let zakatAmount = 0;
            let currentNisab = 0;
            
            if (moneyType === 'gold') {
                currentNisab = nisab.gold;
                if (amount >= currentNisab) {
                    isNisabReached = true;
                    zakatAmount = amount * 0.025;
                }
            } else if (moneyType === 'silver') {
                currentNisab = nisab.silver;
                if (amount >= currentNisab) {
                    isNisabReached = true;
                    zakatAmount = amount * 0.025;
                }
            } else if (moneyType === 'cash') {
                 resultDiv.innerHTML = `<span class="text-red-600">لحساب زكاة النقد، يرجى استخدام حاسبة عروض التجارة وإدخال سعر الذهب لحساب النصاب بدقة.</span>`;
                 return;
            }

            if (isNisabReached) {
                const unit = moneyType === 'cash' ? 'وحدة نقدية' : 'غرام';
                resultDiv.innerHTML = `المال بلغ النصاب. مقدار الزكاة الواجبة هو: <span class="text-green-700">${zakatAmount.toFixed(2)}</span> ${unit}.`;
                showDuaButton(resultDiv, 'مالي', zakatAmount);
            } else {
                resultDiv.innerHTML = `<span class="text-blue-600">المال لم يبلغ النصاب (${currentNisab} غرام). لا تجب فيه الزكاة.</span>`;
            }
        }

        function calculateTradeZakat() {
            const tradeValue = parseFloat(document.getElementById('trade_value').value) || 0;
            const tradeCash = parseFloat(document.getElementById('trade_cash').value) || 0;
            const tradeDebt = parseFloat(document.getElementById('trade_debt').value) || 0;
            const goldPrice = parseFloat(document.getElementById('gold_price_input_trade').value);
            const resultDiv = document.getElementById('trade_result');

            if (isNaN(goldPrice) || goldPrice <= 0) {
                 resultDiv.innerHTML = `<span class="text-red-600">الرجاء إدخال سعر جرام الذهب لحساب النصاب.</span>`;
                return;
            }

            const totalValue = tradeValue + tradeCash + tradeDebt;
            const nisabValue = nisab.gold * goldPrice;
            
            if (totalValue >= nisabValue) {
                const zakatAmount = totalValue * 0.025;
                resultDiv.innerHTML = `مجموع المال (${totalValue.toFixed(2)}) بلغ النصاب (${nisabValue.toFixed(2)}).<br> مقدار الزكاة الواجبة هو: <span class="text-green-700">${zakatAmount.toFixed(2)}</span> وحدة نقدية.`;
                 showDuaButton(resultDiv, 'تجارتي', zakatAmount);
            } else {
                 resultDiv.innerHTML = `<span class="text-blue-600">مجموع المال (${totalValue.toFixed(2)}) لم يبلغ النصاب (${nisabValue.toFixed(2)}). لا تجب فيه الزكاة.</span>`;
            }
        }
        
        function calculateAgricultureZakat() {
            const cropAmount = parseFloat(document.getElementById('crop_amount').value);
            const irrigation = document.getElementById('irrigation_method').value;
            const resultDiv = document.getElementById('agriculture_result');
            const nisabAgriculture = 653; 

            if (isNaN(cropAmount) || cropAmount <= 0) {
                resultDiv.innerHTML = `<span class="text-red-600">الرجاء إدخال كمية صحيحة للمحصول.</span>`;
                return;
            }

            if (cropAmount >= nisabAgriculture) {
                const rate = irrigation === 'natural' ? 0.10 : 0.05;
                const zakatAmount = cropAmount * rate;
                resultDiv.innerHTML = `المحصول بلغ النصاب. مقدار الزكاة الواجبة هو: <span class="text-green-700">${zakatAmount.toFixed(2)}</span> كيلوجرام.`;
                 showDuaButton(resultDiv, 'زرعي وثماري', zakatAmount);
            } else {
                resultDiv.innerHTML = `<span class="text-blue-600">المحصول لم يبلغ النصاب (${nisabAgriculture} كجم). لا تجب فيه الزكاة.</span>`;
            }
        }


        // Chart.js for Recipients
        const recipientData = { labels: ['الفقراء', 'المساكين', 'العاملون عليها', 'المؤلفة قلوبهم', 'في الرقاب', 'الغارمون', 'في سبيل الله', 'ابن السبيل'], descriptions: { 'الفقراء': 'وهم الذين لا يجدون شيئاً من الكفاية أو يجدون أقل من نصفها. حاجتهم شديدة.', 'المساكين': 'وهم الذين يجدون نصف الكفاية أو أكثرها ولكن لا يجدون تمامها. حالهم أحسن من الفقراء ولكنهم محتاجون.', 'العاملون عليها': 'وهم الذين يعينهم الحاكم لجمع الزكاة وتوزيعها، ويُعطون أجرتهم منها.', 'المؤلفة قلوبهم': 'وهم السادة المطاعون في أقوامهم ممن يرجى إسلامهم، أو كف شرهم عن المسلمين، أو يرجى بعطائهم قوة إيمانهم.', 'في الرقاب': 'ويشمل تحرير الأرقاء المسلمين من العبودية، ومساعدة الأسرى المسلمين على التحرر.', 'الغارمون': 'وهم المدينون الذين تحملوا ديناً في غير معصية وعجزوا عن سداده.', 'في سبيل الله': 'والمقصود به عند جمهور الفقهاء الجهاد في سبيل الله وما يتعلق به من تجهيز الجيوش. ووسعه بعض المعاصرين ليشمل كل أعمال الخير العامة.', 'ابن السبيل': 'وهو المسافر الذي انقطع عن بلده ونفدت نفقته، فيُعطى ما يوصله إلى بلده وإن كان غنياً فيه.'}, datasets: [{ data: [12.5, 12.5, 12.5, 12.5, 12.5, 12.5, 12.5, 12.5], backgroundColor: ['#A0937D', '#B6A48D', '#CBAF87', '#DEC9A4', '#E7D9B9', '#BFB29E', '#AD9F8A', '#9B8B78'], hoverBackgroundColor: ['#867A68', '#9C8C77', '#B09670', '#C4B08E', '#D0BF9A', '#A59987', '#948775', '#827464'], borderColor: '#FDF6E3', borderWidth: 3, hoverOffset: 15 }] };
        const ctx = document.getElementById('recipientsChart').getContext('2d');
        const recipientsChart = new Chart(ctx, { type: 'doughnut', data: recipientData, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { font: { family: "'Cairo', sans-serif", size: 14 }, color: '#65451F', boxWidth: 20, padding: 20 }}, tooltip: { enabled: true, titleFont: { family: "'Cairo', sans-serif" }, bodyFont: { family: "'Cairo', sans-serif" }}}, onClick: (event, elements) => { if (elements.length > 0) { const i = elements[0].index; const title = recipientData.labels[i]; const description = recipientData.descriptions[title]; document.getElementById('recipient-title').innerText = title; document.getElementById('recipient-description').innerText = description; }}, onHover: (event, elements) => { if (elements.length > 0) { const i = elements[0].index; const title = recipientData.labels[i]; const description = recipientData.descriptions[title]; document.getElementById('recipient-title').innerText = title; document.getElementById('recipient-description').innerText = description; event.native.target.style.cursor = 'pointer'; } else { event.native.target.style.cursor = 'default'; }}} });
        
        // Accordion functionality
        const accordionHeaders = document.querySelectorAll('.accordion-header');
        accordionHeaders.forEach(header => { header.addEventListener('click', () => { const content = header.nextElementSibling; const arrow = header.querySelector('span:last-child'); document.querySelectorAll('.accordion-content').forEach(c => { if (c !== content) { c.style.maxHeight = null; c.previousElementSibling.querySelector('span:last-child').classList.remove('rotate-180'); }}); if (content.style.maxHeight) { content.style.maxHeight = null; arrow.classList.remove('rotate-180'); } else { content.style.maxHeight = content.scrollHeight + "px"; arrow.classList.add('rotate-180'); }}); });

        // Expert API functionality
        const askButton = document.getElementById('ask-expert-btn');
        const loader = document.getElementById('expert-loader');
        const answerDiv = document.getElementById('expert-answer');
        const questionInput = document.getElementById('zakat-question');

        async function askExpert() {
            const question = questionInput.value;
            if (!question.trim()) {
                answerDiv.innerText = "الرجاء كتابة سؤالك أولاً.";
                return;
            }

            loader.classList.remove('hidden');
            answerDiv.innerText = "";
            askButton.disabled = true;

            const prompt = `بصفتك خبيرًا في الفقه الإسلامي، وبالاستناد إلى محتوى كتاب "الفقه الواضح"، أجب عن السؤال التالي المتعلق بالزكاة إجابة واضحة ومفصلة ومبنية على الأدلة من القرآن والسنة مع مراعاة آراء المذاهب الأربعة قدر الإمكان. السؤال هو: ${question}`;
            
            const chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
            const payload = { contents: chatHistory };
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    const errorBody = await response.text();
                    throw new Error(`HTTP error! status: ${response.status}, body: ${errorBody}`);
                }
                
                const result = await response.json();
                
                if (result.error) {
                    console.error("API Error:", result.error);
                    answerDiv.innerText = `حدث خطأ من الواجهة البرمجية: ${result.error.message}`;
                } else if (result.candidates && result.candidates.length > 0 && result.candidates[0].content && result.candidates[0].content.parts && result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    answerDiv.innerText = text;
                } else {
                    console.error("Unexpected API response structure:", result);
                    answerDiv.innerText = "عذراً، لم أتمكن من فهم الرد من الخادم. يرجى المحاولة مرة أخرى.";
                }
            } catch (error) {
                console.error("Error calling Expert API:", error);
                answerDiv.innerText = "حدث خطأ أثناء محاولة الحصول على إجابة. يرجى التحقق من اتصالك بالإنترنت والمحاولة مرة أخرى.";
            } finally {
                loader.classList.add('hidden');
                askButton.disabled = false;
            }
        }

        // Dua Modal Logic
        const duaModal = document.getElementById('dua-modal');
        const duaLoader = document.getElementById('dua-loader');
        const duaText = document.getElementById('dua-text');

        function openModal() {
            duaModal.classList.remove('hidden');
        }

        function closeModal() {
            duaModal.classList.add('hidden');
        }

        async function getDua(context, amount) {
            openModal();
            duaLoader.classList.remove('hidden');
            duaText.innerText = "";
            
            const prompt = `اكتب دعاءً قصيراً ومؤثراً باللغة العربية لشخص أخرج زكاة ${context} بمقدار ${amount}. يجب أن يطلب الدعاء من الله قبول الزكاة والبركة في المال والأهل والرزق.`;

            const chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
            const payload = { contents: chatHistory };
            const apiKey = "AIzaSyB1-iIebF4COUQiFFEWqqGMjzo9TaWrmMA";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
            
            try {
                 const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                     throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                 if (result.candidates && result.candidates.length > 0 && result.candidates[0].content && result.candidates[0].content.parts && result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    duaText.innerText = text;
                } else {
                    console.error("Unexpected API response for Dua:", result);
                    duaText.innerText = "اللهم تقبل منا إنك أنت السميع العليم.";
                }
            } catch(error) {
                console.error("Error calling API for Dua:", error);
                duaText.innerText = "اللهم تقبل منا صالح الأعمال وبارك لنا في أرزاقنا.";
            } finally {
                duaLoader.classList.add('hidden');
            }

        }

        // Initial call to set correct nisab info
        updateNisabInfo();
    </script>
    <footer style="text-align: center; margin-top: 30px; padding: 20px; border-top: 1px solid #eee; font-family: 'Noto Kufi Arabic', sans-serif; direction: rtl;">
        <p>صمم بواسطة: أحمد علام</p>
        <p>طالب بمركز الثقافة الإسلامية بالمنوفية</p>
    </footer>
</body>
</html>
